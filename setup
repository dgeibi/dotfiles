#!/bin/bash
# copy from https://github.com/riobard/dotfiles/blob/master/setup

set -e

[ ! -e ~/code ] && mkdir -p ~/code

export DOTFILES_DIR=${HOME}/code/dotfiles

linkf() {
    if [ -h ~/."$1" ]; then
        if [ "$(readlink ~/.$1)" !=  "$DOTFILES_DIR/home_root/$1" ]; then
            mv ~/."$1" ~/."$1".old
        else
            return 0
        fi
    elif [ -e ~/."$1" ]; then
        mv ~/."$1" ~/."${1}".old
    fi

    ln -s "$DOTFILES_DIR"/home_root/"$1"  ~/."$1"
    echo ~/."$1" linked
    return 0
}

linkd() {
    if [ -h ~/.config/"$1" ]; then
        if [ "$(readlink ~/.config/$1)" !=  "$DOTFILES_DIR/config/$1" ]; then
            mv ~/.config/"$1" ~/.config/"$1".old
        else
            return 0
        fi
    elif [ -e ~/.config/"$1" ]; then
        mv ~/.config/"$1" ~/.config/"$1".old
    fi

    ln -s "$DOTFILES_DIR"/config/"$1"  ~/.config/
    echo ~/.config/"$1" linked
    return 0
}

linkroot() {
    for file in "$DOTFILES_DIR"/home_root/*; do
        if [ -e "$file" ]; then
            linkf $(basename "$file")
        fi
    done
    echo "files in home_root linked"
    return 0
}

linkconfig() {
    for conf in $DOTFILES_DIR/config/*;do
        if [ -e "$conf" ]; then
            linkd $(basename "$conf")
        fi
    done
    echo "files in .config linked"
    return 0
}

clone() {
    if ! [[ -d "$DOTFILES_DIR" ]]; then
        git clone git@github.com:dgeibi/dotfiles.git "$DOTFILES_DIR"
    else
        cd "$DOTFILES_DIR"
        git pull
    fi
    return 0
}

vim-plug() {
    if ! [[ -e  ~/.config/nvim/autoload/plug.vim ]]; then
        curl -fLo ~/.config/nvim/autoload/plug.vim --create-dirs \
            https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    fi
    nvim +PlugInstall +qa
    return 0
}

installnvm() {
    if ! [[ -e ~/.nvm ]]; then
        git clone https://github.com/creationix/nvm.git ~/.nvm && cd ~/.nvm && git checkout `git describe --abbrev=0 --tags`
        cd -
    fi
    return 0
}

installsbp() {
    sbpbase="$HOME/code/sbp"
    if ! [[ -d "$sbpbase" ]]; then
        git clone https://github.com/brujoand/sbp.git "$sbpbase"
    else
        cd $sbpbase
        git pull
    fi
    if [[ ! -f "$HOME"/.sbp ]]; then
        echo "SBP: Adding default config to $HOME/.sbp"
        cp "$sbpbase"/settings.default "$HOME/.sbp"
    else
        echo "SBP: Found config at $HOME/.sbp"
    fi
}

clone
linkroot
linkconfig
vim-plug
installnvm
installsbp
